name: Update Kahoot Keys

on:
  schedule:
    # 2日ごとの 日本時間 朝5時 (UTC 20:00)
    - cron: '0 20 */2 * *'
  workflow_dispatch:

jobs:
  update-keys:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: pip install requests

      - name: Fetch key and generate files
        env:
          GITHUB_EVENT_NAME: ${{ github.event_name }}
        run: |
          python -c "
          import requests
          import json
          import urllib.parse
          import os
          import time
          import random
          from requests.adapters import HTTPAdapter
          from urllib3.util.retry import Retry

          # ---------------------------------------------------------
          # 1. 時間調整 (手動ならスキップ、自動なら長時間待機)
          # ---------------------------------------------------------
          event_name = os.environ.get('GITHUB_EVENT_NAME')
          
          if event_name == 'workflow_dispatch':
              print('Manual trigger: Skipping long sleep.')
          else:
              min_wait = 300      # 5分
              max_wait = 18000    # 5時間
              wait_seconds = random.randint(min_wait, max_wait)
              
              h = wait_seconds // 3600
              m = (wait_seconds % 3600) // 60
              print(f'Scheduled trigger: Sleeping for {wait_seconds}s ({h}h {m}m)...')
              time.sleep(wait_seconds)

          # ---------------------------------------------------------
          # 2. ブラウザ偽装設定 (Windows Chrome / iPad Safari)
          # ---------------------------------------------------------
          # どちらかを選択
          is_ipad = random.choice([True, False])

          if is_ipad:
              # iPad Safari
              user_agent = 'Mozilla/5.0 (iPad; CPU OS 17_0 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/17.0 Mobile/15E148 Safari/604.1'
              # Safari特有のヘッダー構成
              headers = {
                  'User-Agent': user_agent,
                  'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8',
                  'Accept-Language': 'ja-JP,ja;q=0.9,en-US;q=0.8,en;q=0.7',
                  'Accept-Encoding': 'gzip, deflate, br',
                  'Referer': 'https://create.kahoot.it/',
                  'Sec-Fetch-Dest': 'document',
                  'Sec-Fetch-Mode': 'navigate',
                  'Sec-Fetch-Site': 'none'
              }
              print('Acting as: iPad Safari')
          else:
              # Windows Chrome
              user_agent = 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36'
              # Chrome特有のヘッダー構成 (Sec-Ch-Uaなど)
              headers = {
                  'User-Agent': user_agent,
                  'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8',
                  'Accept-Language': 'ja,en-US;q=0.9,en;q=0.8',
                  'Accept-Encoding': 'gzip, deflate, br',
                  'Referer': 'https://create.kahoot.it/',
                  'Sec-Ch-Ua': '\"Not_A Brand\";v=\"8\", \"Chromium\";v=\"120\", \"Google Chrome\";v=\"120\"',
                  'Sec-Ch-Ua-Mobile': '?0',
                  'Sec-Ch-Ua-Platform': '\"Windows\"',
                  'Sec-Fetch-Dest': 'document',
                  'Sec-Fetch-Mode': 'navigate',
                  'Sec-Fetch-Site': 'none',
                  'Upgrade-Insecure-Requests': '1'
              }
              print('Acting as: Windows Chrome')

          session = requests.Session()
          session.headers.update(headers)

          # ---------------------------------------------------------
          # 3. サイト閲覧シミュレーション (本物のブラウザの動き)
          # ---------------------------------------------------------
          
          # 関数: 失敗しても1回だけリトライする仕組み (人間がF5押す動き)
          def fetch_with_retry(url, description, is_json=False):
              max_retries = 2
              for attempt in range(1, max_retries + 1):
                  try:
                      print(f'Fetching {description}... (Attempt {attempt})')
                      resp = session.get(url, timeout=10)
                      resp.raise_for_status()
                      return resp
                  except Exception as e:
                      print(f'Error fetching {description}: {e}')
                      if attempt < max_retries:
                          # 失敗したら少し長めに待って(20〜40秒)リトライ
                          wait_retry = random.randint(20, 40)
                          print(f'Retrying in {wait_retry} seconds...')
                          time.sleep(wait_retry)
                      else:
                          raise e

          try:
              # Step A: トップページへアクセス
              fetch_with_retry('https://create.kahoot.it/', 'Home Page')
              
              # ページの読み込み待ち（人間が画面を見ている時間）
              time.sleep(random.uniform(2, 5))

              # Step B: ★ここが新機能★ アイコン画像を取りに行く
              # ブラウザはHTMLを取った後、必ずfaviconを取りに行きます。これを再現。
              try:
                  # ヘッダーを画像用に少し変更
                  img_headers = {'Accept': 'image/webp,image/apng,image/*,*/*;q=0.8', 'Sec-Fetch-Dest': 'image'}
                  session.get('https://create.kahoot.it/favicon.ico', headers=img_headers, timeout=5)
                  print('Fetched favicon (acting like a real browser).')
              except:
                  # アイコン取得失敗は致命的ではないので無視
                  pass

              # さらに少し待つ
              time.sleep(random.uniform(3, 8))

              # Step C: 本命のキー取得
              api_url = 'https://apis.kahoot.it/media-api/youtube/key'
              # API用のヘッダー調整
              session.headers.update({'Sec-Fetch-Dest': 'empty', 'Sec-Fetch-Mode': 'cors', 'Sec-Fetch-Site': 'same-site'})
              
              response = fetch_with_retry(api_url, 'API Key', is_json=True)
              
              data = response.json()
              key_value = data['key']
              print('Key fetched successfully!')

              # -----------------------------------------------------
              # 4. ファイル生成と保存
              # -----------------------------------------------------
              base_params = '?autoplay=1&mute=0&controls=1&start=0&origin=https%3A%2F%2Fcreate.kahoot.it&playsinline=1&showinfo=0&rel=0&iv_load_policy=3&modestbranding=1&fs=1&enablejsapi=1&widgetid=1'

              # Config作成
              def make_config(k, hide):
                  cfg = {'enc': k, 'hideTitle': hide}
                  json_str = json.dumps(cfg, separators=(',', ':'))
                  return f'{base_params}&embed_config={urllib.parse.quote(json_str)}'

              final_str_1 = make_config(key_value, False)
              final_str_2 = make_config(key_value, True)

              output_dir = 'keys'
              os.makedirs(output_dir, exist_ok=True)

              with open(os.path.join(output_dir, 'key1.json'), 'w') as f:
                  json.dump({'result': final_str_1}, f, indent=2)

              with open(os.path.join(output_dir, 'key2.json'), 'w') as f:
                  json.dump({'result': final_str_2}, f, indent=2)
              
              print('Files saved.')

          except Exception as e:
              print(f'Critical Error: {e}')
              exit(1)
          "

      - name: Commit and push changes
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          git add keys/key1.json keys/key2.json
          
          if git diff --staged --quiet; then
            echo "No changes to commit."
          else
            git commit -m "Update Kahoot keys [skip ci]"
            git push
          fi
