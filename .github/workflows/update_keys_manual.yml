name: Manual

on:
  workflow_dispatch:
    inputs:
      kahoot_key:
        description: 'Kahootから取得したKeyをここに貼り付け'
        required: true
        type: string

jobs:
  process-key:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Generate files
        env:
          # 入力されたキーを環境変数としてPythonに渡す
          INPUT_KEY: ${{ inputs.kahoot_key }}
        run: |
          python -c "
          import json
          import urllib.parse
          import os

          # 1. GitHubの入力欄からキーを受け取る
          key_value = os.environ.get('INPUT_KEY')
          
          if not key_value:
              print('Error: Key is empty!')
              exit(1)
              
          print(f'Processing key: {key_value[:5]}... (hidden)')

          # 2. ベースパラメータ
          base_params = '?autoplay=1&mute=0&controls=1&start=0&origin=https%3A%2F%2Fcreate.kahoot.it&playsinline=1&showinfo=0&rel=0&iv_load_policy=3&modestbranding=1&fs=1&enablejsapi=1&widgetid=1'

          # 3. 設定生成関数
          def make_config(k, hide):
              cfg = {'enc': k, 'hideTitle': hide}
              json_str = json.dumps(cfg, separators=(',', ':'))
              return f'{base_params}&embed_config={urllib.parse.quote(json_str)}'

          # 4. 生成処理
          final_str_1 = make_config(key_value, False)
          final_str_2 = make_config(key_value, True)

          # 5. ファイル保存
          output_dir = 'keys'
          os.makedirs(output_dir, exist_ok=True)

          with open(os.path.join(output_dir, 'key1.json'), 'w') as f:
              json.dump({'result': final_str_1}, f, indent=2)

          with open(os.path.join(output_dir, 'key2.json'), 'w') as f:
              json.dump({'result': final_str_2}, f, indent=2)
          
          print('Files generated successfully.')
          "

      - name: Commit and push changes
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          git add keys/key1.json keys/key2.json
          
          if git diff --staged --quiet; then
            echo "No changes to commit (Key was the same)."
          else
            git commit -m "Update Kahoot keys manually [skip ci]"
            git push
          fi
