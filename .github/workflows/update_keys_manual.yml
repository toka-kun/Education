name: Manual Update

on:
  workflow_dispatch:
    inputs:
      kahoot_key:
        description: 'Kahootから取得したKeyをここに貼り付け'
        required: true
        type: string

jobs:
  process-key:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Generate files
        env:
          # 入力されたキーを環境変数としてPythonに渡す
          INPUT_KEY: ${{ inputs.kahoot_key }}
        run: |
          python -c "
          import json
          import urllib.parse
          import os

          # 1. GitHubの入力欄からキーを受け取る
          key_value = os.environ.get('INPUT_KEY')
          
          if not key_value:
              print('Error: Key is empty!')
              exit(1)
              
          print(f'Processing key: {key_value[:5]}... (hidden)')

          # 2. ベースパラメータ
          base_params = '?autoplay=1&amp;mute=0&amp;controls=1&amp;start=0&amp;origin=https%3A%2F%2Fcreate.kahoot.it&amp;playsinline=1&amp;showinfo=0&amp;rel=0&amp;iv_load_policy=3&amp;modestbranding=1&amp;fs=1&amp;cc_load_policy=0&amp;enablejsapi=1&amp;widgetid=1&amp;forigin=https%3A%2F%2Fcreate.kahoot.it%2Flearner%2Fcb8cb5ae-d835-4c4a-bc2d-9cc78519d646%2Fcourse%2F6fba06e3-1f76-47a8-9a4a-53c53eb86286%2F0&amp;aoriginsup=1&amp;vf=6'

          # 3. 設定生成関数
          def make_config(k, hide):
              cfg = {'enc': k, 'hideTitle': hide}
              json_str = json.dumps(cfg, separators=(',', ':'))
              return f'{base_params}&amp;embed_config={urllib.parse.quote(json_str)}'

          # 4. 生成処理
          final_str_1 = make_config(key_value, False)
          final_str_2 = make_config(key_value, True)

          # 5. ファイル保存
          output_dir = 'keys'
          os.makedirs(output_dir, exist_ok=True)

          with open(os.path.join(output_dir, 'key1.json'), 'w') as f:
              json.dump({'result': final_str_1}, f, indent=2)

          with open(os.path.join(output_dir, 'key2.json'), 'w') as f:
              json.dump({'result': final_str_2}, f, indent=2)
          
          print('Files generated successfully.')
          "

      - name: Commit and push changes
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          git add keys/key1.json keys/key2.json
          
          if git diff --staged --quiet; then
            echo "No changes to commit (Key was the same)."
          else
            git commit -m "Update Kahoot keys manually [skip ci]"
            git push
          fi
