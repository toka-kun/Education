<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>é«˜éŸ³è³ªã‚¿ã‚¤ãƒ ã‚¹ãƒˆãƒ¬ãƒƒãƒãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ â€” å®Œå…¨ç‰ˆv4</title>
<style>
:root{--primary:#007bff;--primary-dark:#0056b3;--bg:#fafafa}
html,body{height:100%}
body{font-family:"Segoe UI",system-ui,Arial,sans-serif;background:var(--bg);color:#111;margin:0;padding:18px;display:flex;justify-content:center;align-items:flex-start}
.app{width:100%;max-width:980px}
.header{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
h1{font-size:18px;margin:0}
.controls{margin-top:12px;display:grid;gap:10px}
.row{display:flex;gap:8px;align-items:center}
input[type=text]{flex:1;padding:9px;border-radius:6px;border:1px solid #ccc}
button{padding:8px 12px;border-radius:6px;border:none;background:var(--primary);color:#fff;cursor:pointer}
button.secondary{background:#6c757d}
button.ghost{background:transparent;color:var(--primary);border:1px solid #ddd}
button:focus{outline:3px solid rgba(0,123,255,0.25)}
.slider-row{display:flex;align-items:center;gap:10px}
input[type=range]{flex:1}
.video-wrap{margin-top:14px;display:flex;flex-direction:column;gap:12px}
video{width:100%;border-radius:8px;background:#000}
audio{width:100%;border-radius:8px;outline:none}
.status{margin-top:10px;font-size:14px;font-weight:bold}
.presets{display:flex;gap:6px;flex-wrap:wrap}
.preset-btn{padding:6px 8px;border-radius:6px;border:1px solid #ddd;background:#fff;cursor:pointer}
.dropzone{margin-top:8px;padding:12px;border:2px dashed #ccc;border-radius:8px;text-align:center;color:#666;cursor:pointer;transition:all 0.2s}
.small{font-size:13px;color:#555}
.tooltip{font-size:12px;color:#666}
kbd{background:#eee;border-radius:4px;padding:2px 6px;font-size:12px;border:1px solid #ddd}
.bad{color:crimson}
.good{color:green}

@media (pointer: coarse) {
  input[type=range]{height: 28px}
  button{padding:12px 16px}
}
</style>
</head>
<body>
<div class="app" aria-label="é«˜éŸ³è³ªã‚¿ã‚¤ãƒ ã‚¹ãƒˆãƒ¬ãƒƒãƒãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼">
  <div class="header">
    <h1>ğŸ¬ é«˜éŸ³è³ªã‚¿ã‚¤ãƒ ã‚¹ãƒˆãƒ¬ãƒƒãƒãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ â€” å®Œå…¨ç‰ˆ v4</h1>
    <div class="tooltip" id="helpTooltip">ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰: <kbd>Space</kbd>=å†ç”Ÿ/åœæ­¢ <kbd>&larr;&rarr;</kbd>=5ç§’ã‚·ãƒ¼ã‚¯ <kbd>&uarr;&darr;</kbd>=éŸ³é‡ Â±5 <kbd>&lt;</kbd>/<kbd>&gt;</kbd>=é€Ÿåº¦ Â±0.05</div>
  </div>

  <div class="controls" aria-live="polite">
    <div class="row">
      <label for="videoURL" class="small" style="margin-right:8px">å‹•ç”» URL</label>
      <input id="videoURL" type="text" placeholder="https://... ã‚‚ã—ãã¯ã“ã“ã¸ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ­ãƒƒãƒ—" aria-label="å‹•ç”»URLå…¥åŠ›">
      <button id="btnLoad" title="å‹•ç”»ã¨éŸ³å£°ã‚’èª­ã¿è¾¼ã¿">èª­ã¿è¾¼ã¿</button>
      <button id="btnPlay" title="å†ç”Ÿ (Space)" aria-pressed="false">â–¶ å†ç”Ÿ</button>
      <button id="btnPause" title="åœæ­¢" aria-pressed="false">â¸ åœæ­¢</button>
    </div>

    <div class="row">
      <label for="audioURL" class="small" style="margin-right:8px">éŸ³å£° URL</label>
      <input id="audioURL" type="text" placeholder="https://... ã¾ãŸã¯ã“ã“ã¸éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ­ãƒƒãƒ—" aria-label="éŸ³å£°URLå…¥åŠ›">
      <button id="btnSyncNow" class="ghost" title="æ‰‹å‹•ã§éŸ³å£°ã®å†åŒæœŸ">å¼·åˆ¶åŒæœŸ</button>
    </div>

    <div id="dropzone" class="dropzone" tabindex="0" aria-label="ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã“ã“ã«ãƒ‰ãƒ­ãƒƒãƒ—ã—ã¦èª­ã¿è¾¼ã¿">ğŸ¥ ğŸµ å˜ä½“ãƒ»è¤‡æ•°ã«é–¢ã‚ã‚‰ãšã€ãƒ¡ãƒ‡ã‚£ã‚¢ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã“ã“ã«ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—</div>

    <div class="slider-row" aria-label="éŸ³å£°é…å»¶">
      <label class="small" for="delaySlider">é…å»¶ï¼ˆç§’ï¼‰ <span id="delayValue">0.00</span></label>
      <input id="delaySlider" type="range" min="-1" max="1" step="0.01" value="0" aria-label="éŸ³å£°é…å»¶ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼">
    </div>

    <div class="slider-row" aria-label="éŸ³é‡">
      <label class="small" for="volumeSlider">éŸ³é‡ <span id="volumeValue">100%</span></label>
      <input id="volumeSlider" type="range" min="0" max="100" step="1" value="100" aria-label="éŸ³é‡ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼">
    </div>

    <div class="slider-row" aria-label="å†ç”Ÿé€Ÿåº¦">
      <label class="small" for="speedSlider">é€Ÿåº¦ <span id="speedValue">1.00x</span></label>
      <input id="speedSlider" type="range" min="0.25" max="2" step="0.01" value="1" aria-label="é€Ÿåº¦ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼">
    </div>

    <div class="slider-row" aria-label="ãƒ‰ãƒªãƒ•ãƒˆè£œæ­£å¼·åº¦">
      <label class="small">è£œæ­£ <span id="strengthValue">1.00</span></label>
      <input id="strengthSlider" type="range" min="0" max="10" step="0.01" value="1" aria-label="è£œæ­£å¼·åº¦ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼">
    </div>

    <div class="row">
      <label><input id="loopToggle" type="checkbox" aria-label="ãƒ«ãƒ¼ãƒ—åˆ‡æ›¿"> ãƒ«ãƒ¼ãƒ—å†ç”Ÿ</label>
      <label style="margin-left:8px"><input id="autoSyncToggle" type="checkbox" checked> è‡ªå‹•åŒæœŸ</label>
    </div>

    <div class="row">
      <div class="presets" aria-label="ãƒ—ãƒªã‚»ãƒƒãƒˆ">
        <button id="savePresetBtn" class="preset-btn">ãƒ—ãƒªã‚»ãƒƒãƒˆä¿å­˜</button>
        <button id="loadPresetBtn" class="preset-btn">ãƒ—ãƒªã‚»ãƒƒãƒˆèª­è¾¼</button>
        <button id="exportPresetBtn" class="preset-btn">ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
        <button id="importPresetBtn" class="preset-btn">ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
        <button id="resetPresetsBtn" class="preset-btn">ãƒ—ãƒªã‚»ãƒƒãƒˆå…¨å‰Šé™¤</button>
      </div>
    </div>

    <div id="presetList" class="small"></div>

    <div id="driftDisplay" class="status" aria-live="polite">ãƒ•ã‚¡ã‚¤ãƒ«ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“</div>
    <div id="info" class="small" role="status" aria-live="polite"></div>
  </div>

  <div class="video-wrap">
    <video id="video" controls crossorigin="anonymous" aria-label="å‹•ç”»ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼"></video>
    <audio id="audio" controls crossorigin="anonymous" aria-label="éŸ³å£°ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼" style="display:none;"></audio>
  </div>
</div>

<script>
/* ----- DOM ----- */
const video = document.getElementById('video');
const audio = document.getElementById('audio');
const btnLoad = document.getElementById('btnLoad');
const btnPlay = document.getElementById('btnPlay');
const btnPause = document.getElementById('btnPause');
const btnSyncNow = document.getElementById('btnSyncNow');

const videoURL = document.getElementById('videoURL');
const audioURL = document.getElementById('audioURL');
const dropzone = document.getElementById('dropzone');

const delaySlider = document.getElementById('delaySlider');
const volumeSlider = document.getElementById('volumeSlider');
const speedSlider = document.getElementById('speedSlider');
const strengthSlider = document.getElementById('strengthSlider');
const loopToggle = document.getElementById('loopToggle');
const autoSyncToggle = document.getElementById('autoSyncToggle');

const delayValue = document.getElementById('delayValue');
const volumeValue = document.getElementById('volumeValue');
const speedValue = document.getElementById('speedValue');
const strengthValue = document.getElementById('strengthValue');
const driftDisplay = document.getElementById('driftDisplay');
const info = document.getElementById('info');

const savePresetBtn = document.getElementById('savePresetBtn');
const loadPresetBtn = document.getElementById('loadPresetBtn');
const exportPresetBtn = document.getElementById('exportPresetBtn');
const importPresetBtn = document.getElementById('importPresetBtn');
const resetPresetsBtn = document.getElementById('resetPresetsBtn');
const presetList = document.getElementById('presetList');

/* ----- çŠ¶æ…‹ ----- */
let audioCtx = null, sourceNodeAudio = null, sourceNodeVideo = null, gainNode = null;
let rafId = null;
let audioDelay = 0.0;
let baseSpeed = 1.0;
let userDriftStrength = 1.0;
let driftStrength = 1.0;
let isLooping = false;
let isSyncing = false;
let objectURLs = [];
let activeMode = 'none'; // 'dual', 'video', 'audio', 'none'

const PRESET_KEY = 'ts_player_presets_v1';
const PRESET_SCHEMA_VERSION = 1;

/* ======= ãƒ—ãƒªã‚»ãƒƒãƒˆç®¡ç† ======= */
function loadPresets(){
  try { return JSON.parse(localStorage.getItem(PRESET_KEY)) || {}; } catch(e){ return {}; }
}
function savePresets(obj){
  try { localStorage.setItem(PRESET_KEY, JSON.stringify(obj)); } catch(e) {}
}
function addPreset(name, cfg){
  const ps = loadPresets();
  if(ps[name] && !confirm(`ãƒ—ãƒªã‚»ãƒƒãƒˆ "${name}" ã‚’ä¸Šæ›¸ãã—ã¾ã™ã‹ï¼Ÿ`)) return;
  ps[name] = cfg; savePresets(ps); renderPresetList();
}
function removePreset(name){
  const ps = loadPresets();
  delete ps[name]; savePresets(ps); renderPresetList();
}
function renderPresetList(){
  const ps = loadPresets();
  presetList.innerHTML = '';
  if(Object.keys(ps).length === 0){ presetList.textContent = 'ãƒ—ãƒªã‚»ãƒƒãƒˆãªã—'; return; }
  for(const k of Object.keys(ps)){
    const b = document.createElement('button');
    b.textContent = k; b.className = 'preset-btn';
    b.addEventListener('click', ()=>applyPreset(ps[k]));
    b.addEventListener('contextmenu', (ev)=>{ ev.preventDefault(); if(confirm(`"${k}" ã‚’å‰Šé™¤ï¼Ÿ`)) removePreset(k); });
    presetList.appendChild(b);
  }
}
renderPresetList();

savePresetBtn.addEventListener('click', ()=>{
  const name = prompt('ãƒ—ãƒªã‚»ãƒƒãƒˆå:');
  if(name) { addPreset(name, currentConfig()); showInfo(`ä¿å­˜: ${name}`); }
});
loadPresetBtn.addEventListener('click', ()=>{
  const ps = loadPresets(); const keys = Object.keys(ps);
  if(!keys.length) return alert('ãƒ—ãƒªã‚»ãƒƒãƒˆãªã—');
  const name = prompt('èª­è¾¼ãƒ—ãƒªã‚»ãƒƒãƒˆå:\n' + keys.join(', '));
  if(name && ps[name]) { applyPreset(ps[name]); showInfo(`é©ç”¨: ${name}`); }
});
exportPresetBtn.addEventListener('click', ()=>{
  const blob = new Blob([JSON.stringify(loadPresets(), null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'ts_presets.json'; a.click(); URL.revokeObjectURL(url);
});
importPresetBtn.addEventListener('click', ()=>{
  const inp = document.createElement('input'); inp.type = 'file'; inp.accept = 'application/json';
  inp.onchange = ()=> {
    const reader = new FileReader();
    reader.onload = ()=> {
      try{
        const data = JSON.parse(reader.result);
        const ps = loadPresets(); let count = 0;
        for(const [k,v] of Object.entries(data)){
          const valid = validatePresetObject(v);
          if(valid) { ps[k] = valid; count++; }
        }
        savePresets(ps); renderPresetList(); showInfo(`ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Œäº† (${count}ä»¶)`);
      }catch(e){ alert('ä¸æ­£ãªãƒ•ã‚¡ã‚¤ãƒ«ã§ã™'); }
    };
    if(inp.files[0]) reader.readAsText(inp.files[0]);
  };
  inp.click();
});
resetPresetsBtn.addEventListener('click', ()=>{
  if(confirm('å…¨å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')){ localStorage.removeItem(PRESET_KEY); renderPresetList(); showInfo('ãƒªã‚»ãƒƒãƒˆå®Œäº†'); }
});

function validatePresetObject(obj){
  if(!obj || typeof obj !== 'object') return null;
  const v = {};
  if(typeof obj.delay === 'number') v.delay = Math.max(-10, Math.min(10, obj.delay));
  if(typeof obj.volume === 'number') v.volume = Math.max(0, Math.min(100, Math.round(obj.volume)));
  if(typeof obj.speed === 'number') v.speed = Math.max(0.25, Math.min(2, obj.speed));
  if(typeof obj.strength === 'number') v.strength = Math.max(0, Math.min(10, obj.strength));
  if(typeof obj.loop === 'boolean') v.loop = obj.loop;
  return Object.keys(v).length ? v : null;
}
function currentConfig(){
  return { version: PRESET_SCHEMA_VERSION, delay: parseFloat(delaySlider.value), volume: parseInt(volumeSlider.value), speed: parseFloat(speedSlider.value), strength: parseFloat(strengthSlider.value), loop: loopToggle.checked };
}
function applyPreset(cfg){
  if(cfg.delay !== undefined) { delaySlider.value = cfg.delay; audioDelay = cfg.delay; delayValue.textContent = cfg.delay.toFixed(2); }
  if(cfg.volume !== undefined) { volumeSlider.value = cfg.volume; applyVolume(cfg.volume); }
  if(cfg.speed !== undefined) { speedSlider.value = cfg.speed; baseSpeed = cfg.speed; video.playbackRate = audio.playbackRate = baseSpeed; speedValue.textContent = baseSpeed.toFixed(2) + 'x'; updateStrength(); }
  if(cfg.strength !== undefined) { strengthSlider.value = cfg.strength; userDriftStrength = cfg.strength; updateStrength(); }
  if(cfg.loop !== undefined) { loopToggle.checked = cfg.loop; video.loop = audio.loop = cfg.loop; }
}

function showInfo(msg, isErr=false){
  info.textContent = msg; info.className = isErr ? 'small bad' : 'small';
}

/* ======= AudioContext å®‰å…¨åŒ– ======= */
function ensureAudioContext(){
  try {
    if(!audioCtx || audioCtx.state === 'closed') audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    if(audioCtx.state === 'suspended') audioCtx.resume().catch(()=>{});

    if(!gainNode) {
      gainNode = audioCtx.createGain();
      gainNode.connect(audioCtx.destination);
    }
    gainNode.gain.value = parseFloat(volumeSlider.value)/100 || 1.0;

    try { if(!sourceNodeAudio) sourceNodeAudio = audioCtx.createMediaElementSource(audio); } catch(e){}
    try { if(!sourceNodeVideo) sourceNodeVideo = audioCtx.createMediaElementSource(video); } catch(e){}

    if(sourceNodeAudio) try { sourceNodeAudio.disconnect(); } catch(e){}
    if(sourceNodeVideo) try { sourceNodeVideo.disconnect(); } catch(e){}

    if(activeMode === 'video' && sourceNodeVideo) {
      sourceNodeVideo.connect(gainNode);
    } else if((activeMode === 'audio' || activeMode === 'dual') && sourceNodeAudio) {
      sourceNodeAudio.connect(gainNode);
    }
  } catch(e) { 
    applyVolume(parseInt(volumeSlider.value)); // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
  }
}

/* ======= ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ãƒ»ãƒ¢ãƒ¼ãƒ‰åˆ¤å®š ======= */
function clearMedia() {
  video.removeAttribute('src'); audio.removeAttribute('src');
  try { video.load(); audio.load(); } catch(e){}
}
function clearObjectURLs(){
  objectURLs.forEach(url => URL.revokeObjectURL(url));
  objectURLs = [];
}

// ãƒ¢ãƒ¼ãƒ‰ã«å¿œã˜ãŸUIè¡¨ç¤ºåˆ‡æ›¿
function updatePlayerVisibility() {
  if (activeMode === 'dual') {
    video.style.display = 'block';
    audio.style.display = 'block';
  } else if (activeMode === 'video') {
    video.style.display = 'block';
    audio.style.display = 'none';
  } else if (activeMode === 'audio') {
    video.style.display = 'none';
    audio.style.display = 'block';
  } else {
    video.style.display = 'block';
    audio.style.display = 'none';
  }
}

function loadMedia(vSrc, aSrc) {
  clearMedia();
  video.muted = false; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯éŸ³å‡ºã—
  
  if(vSrc && aSrc && vSrc !== aSrc) {
    activeMode = 'dual';
    video.src = vSrc; audio.src = aSrc;
    video.muted = true; // ãƒ‡ãƒ¥ã‚¢ãƒ«æ™‚ã¯å‹•ç”»ã‚’ãƒŸãƒ¥ãƒ¼ãƒˆã—éŸ³å£°ã‚¿ã‚°ã«ä»»ã›ã‚‹
    driftDisplay.textContent = 'ã‚ºãƒ¬: 0.000 ç§’';
    driftDisplay.style.color = 'green';
  } else if(vSrc) {
    activeMode = 'video';
    video.src = vSrc;
    driftDisplay.textContent = 'â–¶ å‹•ç”»å˜ä½“ãƒ¢ãƒ¼ãƒ‰ (åŒæœŸè£œæ­£ã¯ç„¡åŠ¹åŒ–ã•ã‚Œã¾ã™)';
    driftDisplay.style.color = '#007bff';
  } else if(aSrc) {
    activeMode = 'audio';
    audio.src = aSrc;
    driftDisplay.textContent = 'ğŸµ éŸ³å£°å˜ä½“ãƒ¢ãƒ¼ãƒ‰ (åŒæœŸè£œæ­£ã¯ç„¡åŠ¹åŒ–ã•ã‚Œã¾ã™)';
    driftDisplay.style.color = '#007bff';
  } else {
    activeMode = 'none';
    driftDisplay.textContent = 'ãƒ•ã‚¡ã‚¤ãƒ«ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“';
    driftDisplay.style.color = 'inherit';
  }

  updatePlayerVisibility();
  showInfo(activeMode !== 'none' ? 'èª­ã¿è¾¼ã¿å®Œäº†ã€‚å†ç”Ÿãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„' : '');
}

['dragenter','dragover','dragleave','drop'].forEach(evt => dropzone.addEventListener(evt, e => {
  e.preventDefault();
  dropzone.style.borderColor = (evt==='dragenter'||evt==='dragover') ? '#007bff' : '#ccc';
  dropzone.style.background = (evt==='dragenter'||evt==='dragover') ? '#f6fbff' : '';
}));

dropzone.addEventListener('drop', e => {
  if(e.dataTransfer && e.dataTransfer.files.length) handleFiles(e.dataTransfer.files);
});
dropzone.addEventListener('click', ()=>{ 
  const inp = document.createElement('input'); inp.type='file'; inp.accept='audio/*,video/*'; inp.multiple=true; 
  inp.onchange = ()=> handleFiles(inp.files); inp.click(); 
});

function handleFiles(files){
  clearObjectURLs();
  let vFile = null, aFile = null;
  const fileArray = Array.from(files);

  if(fileArray.length === 1) {
    if(fileArray[0].type.startsWith('video/')) vFile = fileArray[0];
    else aFile = fileArray[0];
  } else {
    fileArray.forEach(f => {
      if(f.type.startsWith('video/')) vFile = f;
      else if(f.type.startsWith('audio/')) aFile = f;
    });
  }

  const vUrl = vFile ? URL.createObjectURL(vFile) : null;
  const aUrl = aFile ? URL.createObjectURL(aFile) : null;
  if(vUrl) objectURLs.push(vUrl);
  if(aUrl) objectURLs.push(aUrl);

  loadMedia(vUrl, aUrl);
}

btnLoad.addEventListener('click', ()=> loadMedia(videoURL.value.trim() || null, audioURL.value.trim() || null));

/* ======= å†ç”Ÿåˆ¶å¾¡ ======= */
function waitForMetadata(el){
  return new Promise(resolve => {
    if(!el.src) return resolve();
    if(el.readyState >= 1) return resolve();
    const onLoaded = ()=>{ el.removeEventListener('loadedmetadata', onLoaded); resolve(); };
    el.addEventListener('loadedmetadata', onLoaded);
    setTimeout(resolve, 3000);
  });
}

btnPlay.addEventListener('click', async ()=>{
  if(activeMode === 'none') return showInfo('ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚Šã¾ã›ã‚“', true);

  ensureAudioContext();
  try{ if(audioCtx && audioCtx.state === 'suspended') await audioCtx.resume(); }catch(e){}
  await Promise.all([waitForMetadata(video), waitForMetadata(audio)]);

  if(activeMode === 'dual') {
    audio.currentTime = Math.max(0, (video.currentTime||0) + audioDelay);
    try{ await Promise.all([video.play(), audio.play()]); }catch(e){}
    startSyncLoop();
  } else if(activeMode === 'video') {
    try{ await video.play(); }catch(e){}
  } else if(activeMode === 'audio') {
    try{ await audio.play(); }catch(e){}
  }
  
  btnPlay.setAttribute('aria-pressed', 'true'); btnPause.setAttribute('aria-pressed', 'false');
});

btnPause.addEventListener('click', ()=>{
  video.pause(); audio.pause(); stopSyncLoop();
  btnPlay.setAttribute('aria-pressed', 'false'); btnPause.setAttribute('aria-pressed', 'true');
});

btnSyncNow.addEventListener('click', ()=>{
  if(activeMode !== 'dual') return showInfo('ãƒ‡ãƒ¥ã‚¢ãƒ«ãƒ¢ãƒ¼ãƒ‰ã§ã®ã¿æœ‰åŠ¹ã§ã™');
  audio.currentTime = Math.max(0, (isFinite(video.currentTime)?video.currentTime:0) + audioDelay);
  smoothedRate = baseSpeed;
});

/* ======= ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ ======= */
function updateStrength() { driftStrength = Math.max(0.1, Math.min(10, userDriftStrength * baseSpeed)); strengthValue.textContent = driftStrength.toFixed(2); }
delaySlider.addEventListener('input', e => { audioDelay = parseFloat(e.target.value); delayValue.textContent = audioDelay.toFixed(2); });
volumeSlider.addEventListener('input', e => { const v = parseInt(e.target.value); volumeValue.textContent = v + '%'; applyVolume(v); });
function applyVolume(v){
  const vol = v / 100;
  if(gainNode && audioCtx) {
    try{ gainNode.gain.linearRampToValueAtTime(vol, audioCtx.currentTime + 0.05); }catch(e){}
  } else {
    audio.volume = vol; video.volume = vol;
  }
}
speedSlider.addEventListener('input', e => { 
  baseSpeed = parseFloat(e.target.value); 
  speedValue.textContent = baseSpeed.toFixed(2) + 'x'; 
  video.playbackRate = audio.playbackRate = baseSpeed; 
  updateStrength(); 
});
strengthSlider.addEventListener('input', e => { userDriftStrength = parseFloat(e.target.value); updateStrength(); });
loopToggle.addEventListener('change', e => { isLooping = e.target.checked; video.loop = audio.loop = isLooping; });

/* ======= åŒæœŸãƒ«ãƒ¼ãƒ— (ãƒ‡ãƒ¥ã‚¢ãƒ«ãƒ¢ãƒ¼ãƒ‰å°‚ç”¨) ======= */
let lastUpdateTime = performance.now();
let smoothedRate = 1.0;

function startSyncLoop(){
  if(isSyncing || activeMode !== 'dual') return;
  isSyncing = true; lastUpdateTime = performance.now(); smoothedRate = baseSpeed;

  function loop(now){
    if(!isSyncing) return;
    if(!autoSyncToggle.checked){
      driftDisplay.textContent = `ã‚ºãƒ¬: ${((video.currentTime||0) + audioDelay - (audio.currentTime||0)).toFixed(3)} ç§’ (è‡ªå‹•ã‚ªãƒ•)`;
      rafId = requestAnimationFrame(loop); return;
    }

    const diff = ((video.currentTime||0) + audioDelay) - (audio.currentTime||0);
    const k = 0.05 * Math.min(1, driftStrength/2);
    const targetRate = baseSpeed * Math.max(0.95, Math.min(1.05, 1 + diff * k));
    
    const dt = Math.min(0.1, (now - lastUpdateTime) / 1000);
    smoothedRate += (targetRate - smoothedRate) * (1 - Math.exp(-10 * dt));

    try{
      audio.playbackRate = Math.max(0.25, Math.min(2.0, smoothedRate));
      ['preservesPitch', 'mozPreservesPitch', 'webkitPreservesPitch'].forEach(p => { if(p in audio) audio[p] = true; });
    }catch(e){}

    driftDisplay.textContent = `ã‚ºãƒ¬: ${diff.toFixed(3)} ç§’`;
    driftDisplay.style.color = Math.abs(diff) < 0.05 ? 'green' : (Math.abs(diff) < 0.2 ? 'orange' : 'red');

    lastUpdateTime = now; rafId = requestAnimationFrame(loop);
  }
  rafId = requestAnimationFrame(loop);
}

function stopSyncLoop(){
  isSyncing = false;
  if(rafId) { cancelAnimationFrame(rafId); rafId = null; }
}

/* ======= ã‚¿ãƒ–ç§»å‹•æ™‚ã®è‡ªå‹•åœæ­¢å‡¦ç† ======= */
document.addEventListener('visibilitychange', () => {
  if (document.hidden) {
    if ((activeMode === 'dual' && !video.paused) || 
        (activeMode === 'video' && !video.paused) || 
        (activeMode === 'audio' && !audio.paused)) {
      btnPause.click();
      showInfo('åˆ¥ã‚¿ãƒ–ãŒé–‹ã‹ã‚ŒãŸãŸã‚ã€å†ç”Ÿã‚’ä¸€æ™‚åœæ­¢ã—ã¾ã—ãŸ');
    }
  }
});

/* ======= ã‚¤ãƒ™ãƒ³ãƒˆãƒ»ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ ======= */
// ã‚·ãƒ¼ã‚¯ãƒ»çµ‚äº†ã‚¤ãƒ™ãƒ³ãƒˆ
['seeking','seeked','ended'].forEach(evt => video.addEventListener(evt, () => {
  if(activeMode !== 'dual') return;
  if(evt === 'seeking') stopSyncLoop();
  else if(evt === 'seeked' && !video.paused) { audio.currentTime = Math.max(0, (video.currentTime||0) + audioDelay); startSyncLoop(); }
  else if(evt === 'ended') stopSyncLoop();
}));

window.addEventListener('keydown', e => {
  if(document.activeElement && ['input','textarea'].includes(document.activeElement.tagName.toLowerCase())) return;
  
  if(e.code === 'Space'){ 
    e.preventDefault(); 
    const isPaused = activeMode === 'audio' ? audio.paused : video.paused;
    isPaused ? btnPlay.click() : btnPause.click(); 
  }
  if(e.code === 'ArrowLeft'){ 
    e.preventDefault(); 
    if(activeMode === 'audio') audio.currentTime = Math.max(0, audio.currentTime - 5);
    else video.currentTime = Math.max(0, video.currentTime - 5); 
  }
  if(e.code === 'ArrowRight'){ 
    e.preventDefault(); 
    if(activeMode === 'audio') audio.currentTime += 5;
    else video.currentTime += 5; 
  }
  if(e.code === 'ArrowUp'){ e.preventDefault(); volumeSlider.value = Math.min(100, parseInt(volumeSlider.value) + 5); volumeSlider.dispatchEvent(new Event('input')); }
  if(e.code === 'ArrowDown'){ e.preventDefault(); volumeSlider.value = Math.max(0, parseInt(volumeSlider.value) - 5); volumeSlider.dispatchEvent(new Event('input')); }
  if(e.key === '<' || e.key === ','){ e.preventDefault(); speedSlider.value = Math.max(0.25, parseFloat(speedSlider.value) - 0.05); speedSlider.dispatchEvent(new Event('input')); }
  if(e.key === '>' || e.key === '.'){ e.preventDefault(); speedSlider.value = Math.min(2.0, parseFloat(speedSlider.value) + 0.05); speedSlider.dispatchEvent(new Event('input')); }
});

// UIé€£æº: å‹•ç”»ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æ¨™æº–ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«æ“ä½œæ™‚
video.addEventListener('play', ()=> { 
  if(activeMode==='dual' && audio.paused) try{ audio.play(); }catch(e){} 
  btnPlay.setAttribute('aria-pressed', 'true'); btnPause.setAttribute('aria-pressed', 'false'); 
});
video.addEventListener('pause', ()=> { 
  if(activeMode==='dual' && !audio.paused) audio.pause(); 
  btnPlay.setAttribute('aria-pressed', 'false'); btnPause.setAttribute('aria-pressed', 'true'); 
});

// UIé€£æº: éŸ³å£°ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æ¨™æº–ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«æ“ä½œæ™‚
audio.addEventListener('play', ()=> { 
  if(activeMode==='dual' && video.paused) try{ video.play(); }catch(e){} 
  btnPlay.setAttribute('aria-pressed', 'true'); btnPause.setAttribute('aria-pressed', 'false'); 
});
audio.addEventListener('pause', ()=> { 
  if(activeMode==='dual' && !video.paused) video.pause(); 
  btnPlay.setAttribute('aria-pressed', 'false'); btnPause.setAttribute('aria-pressed', 'true'); 
});

window.addEventListener('beforeunload', ()=> { try{ if(audioCtx) audioCtx.close(); }catch(e){} clearObjectURLs(); });

delayValue.textContent = parseFloat(delaySlider.value).toFixed(2);
volumeValue.textContent = volumeSlider.value + '%';
speedValue.textContent = parseFloat(speedSlider.value).toFixed(2) + 'x';
strengthValue.textContent = parseFloat(strengthSlider.value).toFixed(2);
</script>
</body>
</html>
